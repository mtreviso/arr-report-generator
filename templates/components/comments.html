
<!-- Template function for rendering comment threads -->
{% macro render_comment_thread(thread, level) %}
    {% set comment = thread.comment %}
    {% set bg_color = "bg-gray-50" if level % 2 == 0 else "bg-white" %}
    {% set indent = level * 20 %}
    
    <div class="comment-thread mb-3 ml-{{ indent }} {{ bg_color }} border-l-4 border-gray-200 rounded-lg shadow-sm overflow-hidden comment-item"
         data-paper="{{ comment['Paper #'] }}" 
         data-type="{{ comment.Type }}" 
         data-role="{{ comment.Role }}">
        <div class="px-4 py-3">
            <div class="flex justify-between items-start">
                <div>
                    <span class="inline-block mr-2 text-xs font-medium text-gray-500">Paper #{{ comment['Paper #'] }}</span>
                    {% if comment.Type == "Review Issue" %}
                        <span class="px-2 py-1 text-xs rounded-full bg-red-100 text-red-800 mr-2">{{ comment.Type }}</span>
                    {% elif comment.Type == "Author-Editor Confidential" %}
                        <span class="px-2 py-1 text-xs rounded-full bg-yellow-100 text-yellow-800 mr-2">{{ comment.Type }}</span>
                    {% else %}
                        <span class="px-2 py-1 text-xs rounded-full bg-blue-100 text-blue-800 mr-2">{{ comment.Type }}</span>
                    {% endif %}
                    <span class="font-medium">{{ comment.Role }}</span>
                    <span class="text-sm text-gray-500 ml-2">{{ comment.Date }}</span>
                </div>
                <a href="{{ comment.Link }}" target="_blank" class="text-indigo-600 hover:text-indigo-900 text-sm">View on OpenReview</a>
            </div>
            <div class="mt-2 markdown-content comment-content" id="comment-{{ comment.NoteId }}">
                <!-- Content will be rendered here -->
            </div>
        </div>
    </div>
    
    {% if thread.children %}
        {% for child in thread.children %}
            {{ render_comment_thread(child, level + 1) }}
        {% endfor %}
    {% endif %}
{% endmacro %}

<div class="px-4 py-5 sm:p-6">
    <!-- Additional styles for markdown content -->
    <style>
        .markdown-content {
            line-height: 1.6;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        
        .markdown-content p {
            margin-top: 0.5em;
            margin-bottom: 0.5em;
        }
        
        .markdown-content h1,
        .markdown-content h2,
        .markdown-content h3,
        .markdown-content h4,
        .markdown-content h5,
        .markdown-content h6 {
            margin-top: 1.5em;
            margin-bottom: 0.5em;
            font-weight: 600;
            line-height: 1.25;
        }
        
        .markdown-content h1 { font-size: 1.5em; }
        .markdown-content h2 { font-size: 1.25em; }
        .markdown-content h3 { font-size: 1.125em; }
        
        .markdown-content ul, 
        .markdown-content ol {
            margin-top: 0.5em;
            margin-bottom: 0.5em;
            padding-left: 1.5em;
        }
        
        .markdown-content ul { list-style-type: disc; }
        .markdown-content ol { list-style-type: decimal; }
        
        .markdown-content li {
            margin-top: 0.25em;
            margin-bottom: 0.25em;
        }
        
        .markdown-content code {
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            padding: 0.2em 0.4em;
            background-color: rgba(175, 184, 193, 0.2);
            border-radius: 0.25em;
            font-size: 0.9em;
            white-space: pre-wrap;
        }
        
        .markdown-content pre {
            padding: 1em;
            margin: 0.5em 0;
            background-color: #f6f8fa;
            border-radius: 0.375em;
            overflow-x: auto;
            white-space: pre;
        }
        
        .markdown-content pre code {
            background-color: transparent;
            padding: 0;
            font-size: 0.9em;
            white-space: pre;
        }
        
        .markdown-content blockquote {
            padding-left: 1em;
            border-left: 0.25em solid #d1d5db;
            color: #6b7280;
            margin: 0.5em 0;
        }
        
        .markdown-content a {
            color: #3b82f6;
            text-decoration: underline;
        }
        
        .markdown-content a:hover {
            color: #2563eb;
        }
        
        .markdown-content img {
            max-width: 100%;
            height: auto;
        }
        
        .markdown-content table {
            border-collapse: collapse;
            width: 100%;
            margin: 1em 0;
        }
        
        .markdown-content table th,
        .markdown-content table td {
            border: 1px solid #d1d5db;
            padding: 0.5em;
        }
        
        .markdown-content table th {
            background-color: #f3f4f6;
        }
        
        .markdown-content hr {
            height: 0.25em;
            padding: 0;
            margin: 1.5em 0;
            background-color: #e5e7eb;
            border: 0;
        }
    </style>

    <!-- Filters for comments -->
    <div class="mb-6 bg-gray-50 p-4 rounded-lg">
        <h3 class="text-lg font-medium text-gray-900 mb-3">Filter Comments</h3>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
                <label for="paper-filter" class="block text-sm font-medium text-gray-700 mb-1">Paper #</label>
                <select id="paper-filter" class="bg-white border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm w-full">
                    <option value="all">All Papers</option>
                    <!-- Paper options will be populated by JavaScript -->
                </select>
            </div>
            <div>
                <label for="type-filter" class="block text-sm font-medium text-gray-700 mb-1">Comment Type</label>
                <select id="type-filter" class="bg-white border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm w-full">
                    <option value="all">All Types</option>
                    <option value="Review Issue">Review Issues</option>
                    <option value="Author-Editor Confidential">Author-Editor Confidential</option>
                    <option value="Confidential Comment">Confidential Comments</option>
                </select>
            </div>
            <div>
                <label for="role-filter" class="block text-sm font-medium text-gray-700 mb-1">Role</label>
                <select id="role-filter" class="bg-white border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm w-full">
                    <option value="all">All Roles</option>
                    <option value="Author">Author</option>
                    <option value="Reviewer">Reviewer</option>
                    <option value="Area Chair">Area Chair</option>
                    <option value="Senior Area Chair">Senior Area Chair</option>
                    <option value="Program Chair">Program Chair</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Threaded view -->
    <div id="comments-threaded">
        {% if comment_trees %}
            <div id="no-comments-message" class="hidden text-center py-8 text-gray-500">No comments match the selected filters.</div>
            
            {% for paper in comment_trees %}
                <div class="paper-section border-t border-gray-200 pt-4 mt-4 first:border-t-0 first:pt-0 first:mt-0" data-paper="{{ paper.paper_num }}">
                    <h3 class="text-lg font-semibold text-gray-800 mb-2">Paper #{{ paper.paper_num }}</h3>
                    {% for thread in paper.threads %}
                        {{ render_comment_thread(thread, 0) }}
                    {% endfor %}
                </div>
            {% endfor %}
        {% else %}
            <div class="text-center py-8 text-gray-500">No comments found.</div>
        {% endif %}
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Populate paper filter dropdown
        const paperFilter = document.getElementById('paper-filter');
        const paperSections = document.querySelectorAll('.paper-section');
        const commentItems = document.querySelectorAll('.comment-item');
        const noCommentsMessage = document.getElementById('no-comments-message');
        
        // Build unique paper numbers set
        const papers = new Set();
        paperSections.forEach(section => {
            papers.add(section.getAttribute('data-paper'));
        });
        
        // Build unique role set
        const roles = new Set();
        commentItems.forEach(item => {
            roles.add(item.getAttribute('data-role'));
        });
        
        // Add paper options to dropdown
        const paperArray = Array.from(papers).sort((a, b) => parseInt(a) - parseInt(b));
        paperArray.forEach(paper => {
            const option = document.createElement('option');
            option.value = paper;
            option.textContent = `Paper #${paper}`;
            paperFilter.appendChild(option);
        });

        // Add role options to dropdown (if not already defined in template)
        const roleFilter = document.getElementById('role-filter');
        if (roleFilter.children.length <= 1) {
            const rolesArray = Array.from(roles).sort();
            rolesArray.forEach(role => {
                if (role && role !== 'all') {
                    const option = document.createElement('option');
                    option.value = role;
                    option.textContent = role;
                    roleFilter.appendChild(option);
                }
            });
        }

        // Filter function
        function filterComments() {
            const selectedPaper = paperFilter.value;
            const selectedType = document.getElementById('type-filter').value;
            const selectedRole = roleFilter.value;
            
            let visibleCount = 0;
            
            // Hide all paper sections initially
            paperSections.forEach(section => {
                section.classList.add('hidden');
            });
            
            // Filter comments
            commentItems.forEach(item => {
                const paperMatch = selectedPaper === 'all' || item.getAttribute('data-paper') === selectedPaper;
                const typeMatch = selectedType === 'all' || item.getAttribute('data-type') === selectedType;
                const roleMatch = selectedRole === 'all' || item.getAttribute('data-role') === selectedRole;
                
                if (paperMatch && typeMatch && roleMatch) {
                    item.classList.remove('hidden');
                    
                    // Show the parent paper section
                    const parentSection = item.closest('.paper-section');
                    if (parentSection) {
                        parentSection.classList.remove('hidden');
                    }
                    
                    visibleCount++;
                } else {
                    item.classList.add('hidden');
                }
            });
            
            // Show "no comments" message if no matches
            if (visibleCount === 0) {
                noCommentsMessage.classList.remove('hidden');
            } else {
                noCommentsMessage.classList.add('hidden');
            }
        }
        
        // Add event listeners to filters
        paperFilter.addEventListener('change', filterComments);
        document.getElementById('type-filter').addEventListener('change', filterComments);
        roleFilter.addEventListener('change', filterComments);
        
        // Render comment content - we'll use a simple approach to avoid markdown issues
        const commentData = {{ comments | tojson }};
        
        // For each comment, find its container element and render paragraphs
        commentData.forEach(comment => {
            const container = document.getElementById(`comment-${comment.NoteId}`);
            if (container) {
                // Split by double newlines to get paragraphs
                const paragraphs = comment.Content.split('/\n\s*\n/').filter(p => p.trim());
                
                // Create HTML content
                let html = '';
                paragraphs.forEach(paragraph => {
                    // Replace single newlines with <br>
                    const formattedParagraph = paragraph.trim().replace('/\n/g', '<br>');
                    html += `<p>${formattedParagraph}</p>`;
                });
                
                container.innerHTML = html;
            }
        });
    });
</script>